<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Individual Performance Indicators Tracker - MERL Officer</title>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* ===== CSS VARIABLES ===== */
    :root {
      --primary: #0d6efd;
      --primary-dark: #0b5ed7;
      --success: #16a34a;
      --success-dark: #059669;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --light: #f8f9fa;
      --light-bg: #f9fafb;
      --card-bg: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --radius: 8px;
      --radius-lg: 12px;
      --transition: all 0.3s ease;
    }

    /* ===== GLOBAL STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== HEADER SECTION ===== */
    .header-container {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 4px solid var(--primary-dark);
    }

    .header-title {
      font-size: 1.75rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .info-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .info-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 0.25rem;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1rem;
      font-weight: 500;
    }

    /* ===== MAIN CONTENT ===== */
    .content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ===== DASHBOARD CARDS ===== */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .dashboard-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      text-align: center;
      transition: var(--transition);
      border-top: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      transition: var(--transition);
    }

    .dashboard-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .dashboard-card:hover::before {
      height: 6px;
    }

    .dashboard-card.success::before {
      background: linear-gradient(90deg, var(--success), var(--success-dark));
    }

    .dashboard-card.warning::before {
      background: linear-gradient(90deg, var(--warning), var(--warning-dark));
    }

    .dashboard-card.danger::before {
      background: linear-gradient(90deg, var(--danger), var(--danger-dark));
    }

    .card-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }

    .card-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .card-chart {
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== CONTROLS SECTION ===== */
    .controls {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .control-group {
      flex: 1;
      min-width: 200px;
    }

    .control-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      transition: var(--transition);
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-sm);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
    }

    .button-group {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-left: auto;
    }

    /* ===== OBJECTIVES SECTION ===== */
    .objective {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: var(--transition);
    }

    .objective:hover {
      box-shadow: var(--shadow-lg);
    }

    .obj-summary {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      cursor: pointer;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-left: 6px solid var(--primary);
      transition: var(--transition);
      user-select: none;
    }

    .obj-summary:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    .obj-summary.status-success {
      border-left-color: var(--success);
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .obj-summary.status-warning {
      border-left-color: var(--warning);
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .obj-summary.status-danger {
      border-left-color: var(--danger);
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    }

    details[open] .obj-summary {
      border-bottom: 2px solid var(--border);
    }

    .obj-title {
      flex: 1;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .obj-stats {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .stat-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      background: white;
      box-shadow: var(--shadow-sm);
    }

    .stat-badge.success {
      color: var(--success);
      background: #dcfce7;
    }

    .stat-badge.warning {
      color: var(--warning);
      background: #fef3c7;
    }

    .stat-badge.danger {
      color: var(--danger);
      background: #fee2e2;
    }

    .progress-container {
      min-width: 300px;
      max-width: 400px;
    }

    .progress-bar {
      height: 12px;
      background: #e5e7eb;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, var(--success-dark) 100%);
      transition: width 0.5s ease;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, var(--warning) 0%, var(--warning-dark) 100%);
    }

    .progress-fill.danger {
      background: linear-gradient(90deg, var(--danger) 0%, var(--danger-dark) 100%);
    }

    .progress-text {
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 0.5rem;
      color: var(--text-secondary);
    }

    /* ===== PANEL/TABLE ===== */
    .panel {
      padding: 1.5rem;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
    }

    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--primary-dark);
    }

    tbody tr {
      background: white;
      transition: var(--transition);
    }

    tbody tr:hover {
      background: #f8f9fa;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    tbody tr:nth-child(even) {
      background: #fafbfc;
    }

    tbody tr:nth-child(even):hover {
      background: #f1f3f5;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .status-select {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      background: white;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
    }

    .status-select option[value="On Track"] {
      color: var(--success);
    }

    .status-select option[value="Moderate"] {
      color: var(--warning);
    }

    .status-select option[value="Lagging"] {
      color: var(--danger);
    }

    .comment-textarea {
      width: 100%;
      min-height: 60px;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      resize: vertical;
      font-family: inherit;
      transition: var(--transition);
    }

    .comment-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
    }

    /* ===== PRIORITY BADGES ===== */
    .priority-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .priority-high {
      background: #fee2e2;
      color: var(--danger);
    }

    .priority-medium {
      background: #fef3c7;
      color: var(--warning);
    }

    .priority-low {
      background: #dbeafe;
      color: var(--primary);
    }

    /* ===== DEADLINE ALERTS ===== */
    .deadline-alert {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .deadline-overdue {
      background: #fee2e2;
      color: var(--danger);
    }

    .deadline-urgent {
      background: #fef3c7;
      color: var(--warning);
    }

    .deadline-upcoming {
      background: #dbeafe;
      color: var(--primary);
    }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header-container {
        padding: 1.5rem 1rem;
      }

      .header-title {
        font-size: 1.25rem;
      }

      .header-info {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .content {
        padding: 1rem;
      }

      .dashboard {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1rem;
      }

      .card-value {
        font-size: 2rem;
      }

      .controls {
        padding: 1rem;
      }

      .control-group {
        min-width: 100%;
      }

      .button-group {
        width: 100%;
        margin-left: 0;
      }

      .btn {
        flex: 1;
        min-width: 120px;
      }

      .obj-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .obj-title {
        font-size: 1rem;
      }

      .obj-stats {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }

      .progress-container {
        width: 100%;
        min-width: 100%;
      }

      .panel {
        padding: 0.75rem;
      }

      .table-wrapper {
        margin: 0 -0.75rem;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
      }

      th:nth-child(3),
      td:nth-child(3) {
        display: none; /* Hide Indicator column on mobile */
      }
    }

    @media (max-width: 576px) {
      .dashboard {
        grid-template-columns: 1fr 1fr;
      }

      .dashboard-card:last-child {
        grid-column: 1 / -1;
      }

      th, td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }

      th:nth-child(2),
      td:nth-child(2) {
        display: none; /* Hide Deliverable column on small mobile */
      }
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .objective {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .deadline-overdue {
      animation: pulse 2s infinite;
    }

    /* ===== PRINT STYLES ===== */
    @media print {
      body {
        background: white;
      }

      .header-container {
        position: static;
        box-shadow: none;
        page-break-after: avoid;
      }

      .controls {
        display: none;
      }

      .objective {
        page-break-inside: avoid;
      }

      .obj-summary {
        background: #f8f9fa !important;
      }
    }

    /* ===== UTILITY CLASSES ===== */
    .text-success {
      color: var(--success);
    }

    .text-warning {
      color: var(--warning);
    }

    .text-danger {
      color: var(--danger);
    }

    .text-muted {
      color: var(--text-muted);
    }

    .font-bold {
      font-weight: 700;
    }

    .mb-2 {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <div class="header-container">
    <div class="header-title">Individual Performance Indicators Tracker</div>
    <div class="header-info">
      <div class="info-card">
        <div class="info-label">Name</div>
        <div class="info-value">Benard Muiruri</div>
      </div>
      <div class="info-card">
        <div class="info-label">Designation</div>
        <div class="info-value">MERL Officer</div>
      </div>
      <div class="info-card">
        <div class="info-label">Period</div>
        <div class="info-value">July 2025 - June 2026</div>
      </div>
      <div class="info-card">
        <div class="info-label">Supervisor</div>
        <div class="info-value">Beryl Oduor<br><small>Senior Project Manager</small></div>
      </div>
    </div>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="content">
    <!-- Dashboard -->
    <div class="dashboard">
      <div class="dashboard-card">
        <div class="card-label">Total Activities</div>
        <div class="card-value" id="dbTotal">0</div>
      </div>
      <div class="dashboard-card success">
        <div class="card-label">On Track</div>
        <div class="card-value text-success" id="dbOn">0</div>
      </div>
      <div class="dashboard-card warning">
        <div class="card-label">Moderate</div>
        <div class="card-value text-warning" id="dbMod">0</div>
      </div>
      <div class="dashboard-card danger">
        <div class="card-label">Lagging</div>
        <div class="card-value text-danger" id="dbLag">0</div>
      </div>
      <div class="dashboard-card">
        <div class="card-label">Overall Progress</div>
        <div class="card-value" id="dbPct">0%</div>
      </div>
      <div class="dashboard-card">
        <div class="card-chart">
          <canvas id="globalPie"></canvas>
        </div>
        <div class="card-label">Status Breakdown</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="controls-row">
        <div class="control-group">
          <label class="control-label">Filter by Timeline</label>
          <select id="filterTimeline" class="form-control" onchange="render()">
            <option value="">All Timelines</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Semi-annual">Semi-annual</option>
            <option value="Annual">Annual</option>
            <option value="Q1">Q1</option>
            <option value="Q2">Q2</option>
            <option value="Q3">Q3</option>
            <option value="Q4">Q4</option>
            <option value="Y1">Y1</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Filter by Status</label>
          <select id="filterStatus" class="form-control" onchange="render()">
            <option value="">All Statuses</option>
            <option value="On Track">On Track</option>
            <option value="Moderate">Moderate</option>
            <option value="Lagging">Lagging</option>
            <option value="">Not Set</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Search Activities</label>
          <input type="text" id="searchBox" class="form-control" placeholder="Search activities, deliverables, indicators..." oninput="render()">
        </div>
      </div>
      <div class="controls-row" style="margin-top: 1rem;">
        <div class="button-group">
          <button class="btn btn-secondary" onclick="toggleAll()">Expand / Collapse All</button>
          <button class="btn btn-success" onclick="exportExcel()">üìä Export Excel</button>
          <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
          <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear Progress</button>
        </div>
      </div>
    </div>

    <!-- Objectives Container -->
    <div id="tracker"></div>
  </div>

  <!-- ===== JAVASCRIPT ===== -->
  <script>
    /* ===== CONFIGURATION ===== */
    const STORAGE_KEY = "MERL_YEAR3_FULL_TRACKER_VFINAL";
    const HISTORY_KEY = "MERL_HISTORY";

    /* ===== DATA STRUCTURE ===== */
    const data = [
      {
        objective: "1. Quality Delivery of MERL Functions",
        activities: [
          { activity: "Design & implement monitoring & evaluation frameworks and tools for COSME", deliverable: "Approved M&E framework & tools", indicator: "Framework implemented", timeline: "Y1", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Ensure execution of functional M&E framework (track outcomes & impacts)", deliverable: "Outcome tracking reports", indicator: "Outcomes tracked monthly", timeline: "Annual", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Maintain activity monitoring logs (easy access & retrieval)", deliverable: "Activity monitoring logs", indicator: "Logs updated within 1 week", timeline: "Monthly", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Analyze collected data for progress assessment and improvement areas", deliverable: "Data analysis notes & recommendations", indicator: "Analyses for each reporting period", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Support development of monitoring tools aligned with ToC and M&E Plan", deliverable: "Monitoring tools & SOPs", indicator: "Tools approved & used", timeline: "As Scheduled", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Monitor & evaluate overall progress on achievement and sustainability of results", deliverable: "Progress & sustainability reports", indicator: "Sustainability assessed", timeline: "Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Coordinate periodic reporting with project team (monthly, quarterly, half-yearly, annual)", deliverable: "Consolidated reports", indicator: "Reports submitted on schedule", timeline: "Monthly/Quarterly/Annual", responsible: "MERL Officer + Project Team", status: "", comments: "", priority: "High" },
          { activity: "Manage & conduct quantitative and qualitative monitoring, evaluations and studies", deliverable: "M&E study reports", indicator: "Studies delivered as planned", timeline: "As scheduled", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Design & implement Project Management Information System (MIS) for COSME", deliverable: "Functional MIS", indicator: "MIS operational & updated", timeline: "Weekly/Monthly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Produce MERL reports (monthly, quarterly, annual)", deliverable: "Progress reports", indicator: "100% reports on time & satisfactory", timeline: "Monthly/Quarterly/Annual", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Resolve data quality issues within 2 weeks with documented actions", deliverable: "DQI log & action records", indicator: "100% DQ issues resolved timely", timeline: "Monthly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Maintain MERL risk tracking & mitigation plans", deliverable: "Updated MERL risk log", indicator: "MERL risks tracked quarterly", timeline: "Quarterly", responsible: "MERL Officer + Project Manager", status: "", comments: "", priority: "Medium" }
        ]
      },
      {
        objective: "2. Managing Project Impact/Results & Partner Accountability",
        activities: [
          { activity: "Coordinate routine monitoring with staff, WROs, YLOs", deliverable: "Monitoring schedules & reports", indicator: "‚â•90% indicators on track", timeline: "Monthly", responsible: "MERL Officer + Partners", status: "", comments: "", priority: "High" },
          { activity: "Track implementation of indicators & measures of sustainability/success", deliverable: "Indicator tracking tables", indicator: "Indicators monitored quarterly", timeline: "Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Conduct quarterly performance & results review sessions", deliverable: "Review minutes & action points", indicator: "‚â•1 review session quarterly", timeline: "Quarterly", responsible: "MERL Officer + Project Team", status: "", comments: "", priority: "High" },
          { activity: "Update project information/results on SAP and PMERL", deliverable: "Updated SAP/PMERL entries", indicator: "100% results updated", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Develop & implement partner MERL capacity strengthening plans", deliverable: "Partner MERL plans", indicator: "Plans in place & tracked", timeline: "Q1", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Implement partner MERL capacity strengthening follow-ups", deliverable: "Training follow-up reports", indicator: "100% plans implemented", timeline: "Semi-annual", responsible: "MERL Officer + Partners", status: "", comments: "", priority: "Medium" },
          { activity: "Track completion of partner follow-up actions", deliverable: "Capacity follow-up log", indicator: "Follow-ups completed on time", timeline: "Q2‚ÄìQ4", responsible: "MERL Officer", status: "", comments: "", priority: "Low" },
          { activity: "Facilitate evidence-based adaptations to implementation", deliverable: "Adaptation briefs", indicator: "‚â•2 adaptations annually", timeline: "Annual", responsible: "MERL Officer + Project Manager", status: "", comments: "", priority: "Medium" },
          { activity: "Support partners to apply MERL standards & accountability mechanisms", deliverable: "Partner guidance notes & dashboards", indicator: "Partners compliant with MERL SOPs", timeline: "Q1‚ÄìQ4", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" }
        ]
      },
      {
        objective: "3. Learning, Knowledge Management & Influencing",
        activities: [
          { activity: "Document case studies, change/impact stories and lessons learned", deliverable: "‚â•3 case studies / stories", indicator: "‚â•3 learning products produced", timeline: "Q2 & Q4", responsible: "MERL Officer + Comms", status: "", comments: "", priority: "Medium" },
          { activity: "Produce evidence products for external networks/forums", deliverable: "Policy briefs / presentations", indicator: "‚â•2 evidence products shared externally", timeline: "Q3 & Q4", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Disseminate monitoring reports to internal & external audiences", deliverable: "Shared monitoring reports", indicator: "Reports disseminated as scheduled", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "Low" },
          { activity: "Develop knowledge products for replication & scaling up", deliverable: "Knowledge briefs & toolkits", indicator: "At least 1 product for scaling", timeline: "Q3", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Create & maintain interactive dashboards and ArcGIS story maps", deliverable: "Live dashboards & story maps", indicator: "Dashboards updated quarterly", timeline: "Q2‚ÄìQ3", responsible: "MERL Officer", status: "", comments: "", priority: "Low" },
          { activity: "Document and share best practices and lessons with partners", deliverable: "Learning briefs", indicator: "Lessons fed into project design", timeline: "Q2 & Q4", responsible: "MERL + Partners", status: "", comments: "", priority: "Low" },
          { activity: "Maintain an updated database of completed interventions & carry out meta-analysis", deliverable: "Intervention database & meta-analysis", indicator: "Database updated annually", timeline: "Q4", responsible: "MERL Officer", status: "", comments: "", priority: "Low" }
        ]
      },
      {
        objective: "4. Capacity Strengthening of Staff, WROs, and YLOs",
        activities: [
          { activity: "Conduct ‚â•2 MERL capacity-building sessions with staff, WROs, YLOs", deliverable: "Training reports", indicator: "‚â•80% show improved skills", timeline: "Q2 & Q3", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Train research assistants and partners on MERL tools & methods", deliverable: "Training materials & records", indicator: "100% RAs & partners trained", timeline: "Q1‚ÄìQ2", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Provide structured coaching, mentorship and follow-up support to partners", deliverable: "Coaching logs & follow-ups", indicator: "100% follow-ups tracked", timeline: "Q1‚ÄìQ4", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Address identified MERL support needs for partners within agreed timelines", deliverable: "Support tracking log", indicator: "100% needs addressed", timeline: "Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Facilitate reflection & learning sessions with staff and partners", deliverable: "Reflection session notes", indicator: "Learning meeting notes & action points", timeline: "Q2 & Q4", responsible: "MERL + Partners", status: "", comments: "", priority: "Low" }
        ]
      },
      {
        objective: "5. Safeguarding & GEI Integration in MERL",
        activities: [
          { activity: "Induct staff, research assistants & partners on Safeguarding and GEI", deliverable: "Induction reports", indicator: "100% inducted", timeline: "Q1", responsible: "MERL Officer + Safeguarding Focal Point", status: "", comments: "", priority: "High" },
          { activity: "Integrate GEI & Safeguarding principles into MERL tools & reports", deliverable: "Revised MERL tools & templates", indicator: "All tools GEI-compliant", timeline: "Q1‚ÄìQ4", responsible: "MERL Officer", status: "", comments: "", priority: "High" },
          { activity: "Conduct quarterly compliance checks on Safeguarding and GEI integration", deliverable: "Compliance reports", indicator: "Quarterly checks completed", timeline: "Quarterly", responsible: "MERL Officer", status: "", comments: "", priority: "Medium" },
          { activity: "Ensure data is disaggregated by sex, age & disability (SADD)", deliverable: "Disaggregated datasets & tables", indicator: "100% datasets SADD", timeline: "Ongoing", responsible: "MERL Officer", status: "", comments: "", priority: "High" }
        ]
      }
    ];

    /* ===== STORAGE FUNCTIONS ===== */
    function loadSaved() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        saved.forEach((obj, i) => {
          if (!data[i] || !obj.activities) return;
          obj.activities.forEach((a, j) => {
            if (!data[i].activities[j]) return;
            data[i].activities[j].status = a.status || "";
            data[i].activities[j].comments = a.comments || "";
            data[i].activities[j].priority = a.priority || data[i].activities[j].priority || "Medium";
            data[i].activities[j].lastUpdated = a.lastUpdated || null;
          });
        });
      } catch (e) {
        console.warn("Error loading saved data:", e);
      }
    }

    function saveAll() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        saveHistory();
      } catch (e) {
        console.warn("Error saving data:", e);
      }
    }

    function saveHistory() {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const snapshot = {
          timestamp: new Date().toISOString(),
          data: JSON.parse(JSON.stringify(data))
        };
        history.push(snapshot);
        // Keep only last 30 snapshots
        if (history.length > 30) history.shift();
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.warn("Error saving history:", e);
      }
    }

    /* ===== COMPUTATION FUNCTIONS ===== */
    function computeCounts(activities) {
      let total = activities.length, on = 0, mod = 0, lag = 0;
      activities.forEach(a => {
        if (a.status === "On Track") on++;
        else if (a.status === "Moderate") mod++;
        else lag++;
      });
      const pct = total === 0 ? 0 : Math.round((on / total) * 100);
      return { total, on, mod, lag, pct };
    }

    function getStatusClass(counts) {
      if (counts.pct >= 70) return 'status-success';
      if (counts.pct >= 40) return 'status-warning';
      return 'status-danger';
    }

    function getProgressClass(pct) {
      if (pct >= 70) return '';
      if (pct >= 40) return 'warning';
      return 'danger';
    }

    /* ===== CHART FUNCTIONS ===== */
    let globalChart = null;
    function updateGlobalChart(on, mod, lag) {
      const ctx = document.getElementById("globalPie").getContext("2d");
      if (globalChart) {
        globalChart.data.datasets[0].data = [on, mod, lag];
        globalChart.update();
        return;
      }
      globalChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['On Track', 'Moderate', 'Lagging'],
          datasets: [{
            data: [on, mod, lag],
            backgroundColor: ['#16a34a', '#f59e0b', '#ef4444'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 10,
                font: { size: 11, weight: 'bold' }
              }
            }
          }
        }
      });
    }

    /* ===== RENDER FUNCTIONS ===== */
    function render() {
      const tracker = document.getElementById("tracker");
      tracker.innerHTML = "";
      
      const timelineFilter = document.getElementById("filterTimeline").value.trim().toLowerCase();
      const statusFilter = document.getElementById("filterStatus").value;
      const searchFilter = document.getElementById("searchBox").value.trim().toLowerCase();

      // Calculate global stats
      let g_total = 0, g_on = 0, g_mod = 0, g_lag = 0;
      data.forEach(obj => {
        const c = computeCounts(obj.activities);
        g_total += c.total;
        g_on += c.on;
        g_mod += c.mod;
        g_lag += c.lag;
      });
      const g_pct = g_total === 0 ? 0 : Math.round((g_on / g_total) * 100);

      // Update dashboard
      document.getElementById("dbTotal").innerText = g_total;
      document.getElementById("dbOn").innerText = g_on;
      document.getElementById("dbMod").innerText = g_mod;
      document.getElementById("dbLag").innerText = g_lag;
      document.getElementById("dbPct").innerText = g_pct + "%";
      updateGlobalChart(g_on, g_mod, g_lag);

      // Render objectives
      data.forEach((obj, objIndex) => {
        const counts = computeCounts(obj.activities);
        
        // Create details element
        const details = document.createElement("details");
        details.className = "objective";
        details.open = true;

        // Create summary
        const summary = document.createElement("summary");
        summary.className = `obj-summary ${getStatusClass(counts)}`;

        const title = document.createElement("div");
        title.className = "obj-title";
        title.textContent = obj.objective;

        const stats = document.createElement("div");
        stats.className = "obj-stats";

        const badges = `
          <span class="stat-badge success">‚úì ${counts.on}</span>
          <span class="stat-badge warning">‚ö† ${counts.mod}</span>
          <span class="stat-badge danger">‚úó ${counts.lag}</span>
        `;
        stats.innerHTML = badges;

        const progressContainer = document.createElement("div");
        progressContainer.className = "progress-container";
        progressContainer.innerHTML = `
          <div class="progress-bar">
            <div class="progress-fill ${getProgressClass(counts.pct)}" style="width: ${counts.pct}%"></div>
          </div>
          <div class="progress-text">${counts.pct}% Complete</div>
        `;

        summary.appendChild(title);
        summary.appendChild(stats);
        summary.appendChild(progressContainer);

        // Create panel
        const panel = document.createElement("div");
        panel.className = "panel";

        const tableWrapper = document.createElement("div");
        tableWrapper.className = "table-wrapper";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Activity</th>
              <th>Deliverable</th>
              <th>Indicator</th>
              <th>Timeline</th>
              <th>Responsible</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Comments / Next Actions</th>
            </tr>
          </thead>
        `;

        const tbody = document.createElement("tbody");

        // Filter and render activities
        let visibleCount = 0;
        obj.activities.forEach((a, actIndex) => {
          // Apply filters
          if (timelineFilter && !String(a.timeline).toLowerCase().includes(timelineFilter)) return;
          if (statusFilter && a.status !== statusFilter) return;
          if (searchFilter) {
            const searchText = `${a.activity} ${a.deliverable} ${a.indicator || ""} ${a.responsible} ${a.comments || ""}`.toLowerCase();
            if (!searchText.includes(searchFilter)) return;
          }

          visibleCount++;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(a.activity)}</td>
            <td>${escapeHtml(a.deliverable)}</td>
            <td>${escapeHtml(a.indicator || "")}</td>
            <td>${escapeHtml(a.timeline)}</td>
            <td>${escapeHtml(a.responsible)}</td>
            <td>
              <select class="status-select" data-obj="${objIndex}" data-act="${actIndex}" onchange="onPriorityChange(this)">
                <option value="High" ${a.priority === "High" ? "selected" : ""}>üî¥ High</option>
                <option value="Medium" ${a.priority === "Medium" ? "selected" : ""}>üü° Medium</option>
                <option value="Low" ${a.priority === "Low" ? "selected" : ""}>üîµ Low</option>
              </select>
            </td>
            <td>
              <select class="status-select" data-obj="${objIndex}" data-act="${actIndex}" onchange="onStatusChange(this)">
                <option value="">-- Select --</option>
                <option value="On Track" ${a.status === "On Track" ? "selected" : ""}>‚úì On Track</option>
                <option value="Moderate" ${a.status === "Moderate" ? "selected" : ""}>‚ö† Moderate</option>
                <option value="Lagging" ${a.status === "Lagging" ? "selected" : ""}>‚úó Lagging</option>
              </select>
            </td>
            <td>
              <textarea class="comment-textarea" data-obj="${objIndex}" data-act="${actIndex}" onchange="onCommentChange(this)" placeholder="Add comments or next actions...">${escapeHtml(a.comments || "")}</textarea>
            </td>
          `;
          tbody.appendChild(tr);
        });

        if (visibleCount > 0) {
          table.appendChild(tbody);
          tableWrapper.appendChild(table);
          panel.appendChild(tableWrapper);
          details.appendChild(summary);
          details.appendChild(panel);
          tracker.appendChild(details);
        }
      });
    }

    /* ===== EVENT HANDLERS ===== */
    function onStatusChange(selectEl) {
      const objIndex = Number(selectEl.dataset.obj);
      const actIndex = Number(selectEl.dataset.act);
      data[objIndex].activities[actIndex].status = selectEl.value || "";
      data[objIndex].activities[actIndex].lastUpdated = new Date().toISOString();
      saveAll();
      render();
    }

    function onCommentChange(textareaEl) {
      const objIndex = Number(textareaEl.dataset.obj);
      const actIndex = Number(textareaEl.dataset.act);
      data[objIndex].activities[actIndex].comments = textareaEl.value || "";
      data[objIndex].activities[actIndex].lastUpdated = new Date().toISOString();
      saveAll();
    }

    function onPriorityChange(selectEl) {
      const objIndex = Number(selectEl.dataset.obj);
      const actIndex = Number(selectEl.dataset.act);
      data[objIndex].activities[actIndex].priority = selectEl.value;
      data[objIndex].activities[actIndex].lastUpdated = new Date().toISOString();
      saveAll();
    }

    /* ===== UTILITY FUNCTIONS ===== */
    function toggleAll() {
      const details = document.querySelectorAll("details.objective");
      const anyClosed = [...details].some(d => !d.open);
      details.forEach(d => d.open = anyClosed);
    }

    function clearAll() {
      if (!confirm("‚ö†Ô∏è This will clear all progress, statuses, and comments. Are you sure?")) return;
      data.forEach(obj => {
        obj.activities.forEach(a => {
          a.status = "";
          a.comments = "";
        });
      });
      saveAll();
      render();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /* ===== EXPORT FUNCTIONS ===== */
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      
      data.forEach(obj => {
        const rows = [
          ["Activity", "Deliverable", "Indicator", "Timeline", "Responsible", "Priority", "Status", "Comments"]
        ];
        
        obj.activities.forEach(a => {
          rows.push([
            a.activity,
            a.deliverable,
            a.indicator || "",
            a.timeline,
            a.responsible,
            a.priority || "Medium",
            a.status || "",
            a.comments || ""
          ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(rows);
        
        // Auto-width columns
        const colWidths = [
          { wch: 50 }, { wch: 35 }, { wch: 30 }, { wch: 20 },
          { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 40 }
        ];
        ws['!cols'] = colWidths;
        
        const sheetName = obj.objective.substring(0, 31).replace(/[/\\?*[\]]/g, "_");
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });
      
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, "-");
      XLSX.writeFile(wb, `MERL_Performance_Tracker_${timestamp}.xlsx`);
    }

    function exportPDF() {
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>MERL Performance Tracker</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
            h1 { color: #0d6efd; text-align: center; margin-bottom: 20px; }
            .header-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
            .info-item { padding: 5px; }
            .info-label { font-weight: bold; color: #555; }
            h2 { color: #0d6efd; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
            th { background: #f0f0f0; font-weight: bold; }
            tr:nth-child(even) { background: #f9f9f9; }
            .status-on { color: #16a34a; font-weight: bold; }
            .status-mod { color: #f59e0b; font-weight: bold; }
            .status-lag { color: #ef4444; font-weight: bold; }
            @media print { body { margin: 20px; } }
          </style>
        </head>
        <body>
          <h1>Individual Performance Indicators Tracker</h1>
          <div class="header-info">
            <div class="info-item"><span class="info-label">Name:</span> Benard Muiruri</div>
            <div class="info-item"><span class="info-label">Designation:</span> MERL Officer</div>
            <div class="info-item"><span class="info-label">Period:</span> July 2025 - June 2026</div>
            <div class="info-item"><span class="info-label">Supervisor:</span> Beryl Oduor (Senior Project Manager)</div>
          </div>
          ${data.map(obj => `
            <h2>${obj.objective}</h2>
            <table>
              <thead>
                <tr>
                  <th>Activity</th>
                  <th>Deliverable</th>
                  <th>Timeline</th>
                  <th>Responsible</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Comments</th>
                </tr>
              </thead>
              <tbody>
                ${obj.activities.map(a => `
                  <tr>
                    <td>${escapeHtml(a.activity)}</td>
                    <td>${escapeHtml(a.deliverable)}</td>
                    <td>${escapeHtml(a.timeline)}</td>
                    <td>${escapeHtml(a.responsible)}</td>
                    <td>${escapeHtml(a.priority || "Medium")}</td>
                    <td class="${a.status === 'On Track' ? 'status-on' : a.status === 'Moderate' ? 'status-mod' : a.status === 'Lagging' ? 'status-lag' : ''}">${escapeHtml(a.status || "Not Set")}</td>
                    <td>${escapeHtml(a.comments || "")}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `).join('')}
        </body>
        </html>
      `;
      
      const printWindow = window.open("", "_blank", "width=900,height=700");
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    /* ===== INITIALIZATION ===== */
    loadSaved();
    render();

    // Request notification permission on load
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }

    console.log("‚úÖ MERL Performance Tracker loaded successfully");
    console.log(`üìä Total activities: ${data.reduce((sum, obj) => sum + obj.activities.length, 0)}`);
  </script>
</body>
</html>
