<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>Individual Performance Indicators Tracker</title>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f9fafb;
      color: #222;
    }

    /* ===== Fixed Header Section ===== */
    .header-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ffffff;
      border-bottom: 3px solid #0d6efd;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px 40px;
      z-index: 1000;
    }

    .header-title {
      font-size: 1.6rem;
      font-weight: 700;
      text-align: center;
      color: #0d6efd;
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .header-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }

    .header-table td {
      padding: 6px 10px;
      vertical-align: top;
    }

    .label {
      font-weight: 600;
      color: #444;
      width: 200px;
    }

    .value {
      color: #000;
    }

    /* ===== Main Content Area ===== */
    .content {
      margin-top: 230px; /* prevents overlap with fixed header */
      padding: 30px 40px;
    }

    hr {
      border: 0;
      border-top: 2px solid #e5e7eb;
      margin: 25px 0;
    }
  </style>
</head>
<body>

  <!-- ===== Fixed Header Section ===== -->
  <div class="header-container">
    <div class="header-title">Individual Performance Indicators Tracker</div>
    <table class="header-table">
      <tr>
        <td class="label">Name:</td>
        <td class="value">Benard Muiruri</td>
      </tr>
      <tr>
        <td class="label">Designation:</td>
        <td class="value">MERL Officer</td>
      </tr>
      <tr>
        <td class="label">Period:</td>
        <td class="value">1st July 2025 to 30th June 2026</td>
      </tr>
      <tr>
        <td class="label">Supervisor:</td>
        <td class="value">
          Beryl Oduor<br />
          Senior Project Manager
        </td>
      </tr>
    </table>
  </div>
  <!-- ===== Main Content Section ===== -->
  <div class="content">
    <hr />
    <div id="objectives-container"></div>
  </div>
</body>
</html>

  <!-- Chart.js for pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#6b7280;
      --accent:#2563eb; --green:#16a34a; --yellow:#f59e0b; --red:#ef4444;
    }
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:18px;color:#0f172a}
    header{background:var(--accent);color:#fff;padding:14px;border-radius:8px}
    header h1{margin:0;font-size:18px}
    .small{font-size:12px;color:rgba(255,255,255,0.9);margin-top:6px}
    .topbar{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0;align-items:center}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(2,6,23,0.06);min-width:140px;text-align:center;flex:1}
    .controls{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .controls input[type="text"], .controls select{padding:8px;border-radius:6px;border:1px solid #d1d5db;min-width:180px}
    .controls button{padding:8px 10px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .controls button.alt{background:#111827}
    .tracker{margin-top:14px}
    details.objective{margin-bottom:12px;border-radius:8px;overflow:hidden}
    summary.obj-summary{display:flex;align-items:center;gap:12px;padding:12px;background:#f1f5f9;cursor:pointer;border-radius:8px}
    .obj-title{font-weight:700;flex:1}
    .progress-box{min-width:260px;max-width:380px}
    .progress-bar{height:14px;background:#eef2ff;border-radius:8px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--green),#059669);transition:width .35s ease}
    .summary-text{font-size:13px;color:var(--muted);min-width:260px}
    details[open] summary.obj-summary{background:#fff}
    .panel{padding:12px;border:1px solid #e6eefc;background:var(--card)}
    table{width:100%;border-collapse:collapse;background:var(--card);font-size:13px}
    th, td{padding:8px;border:1px solid #e6eefc;vertical-align:top;text-align:left}
    th{background:#f8fafc;color:#0f172a}
    select.status{padding:6px;border-radius:6px;border:1px solid #d1d5db}
    textarea.comment{width:100%;min-height:44px;padding:6px;border-radius:6px;border:1px solid #d1d5db;resize:vertical}
    .muted{color:var(--muted);font-size:12px}
    .status-on{color:var(--green);font-weight:700}
    .status-mod{color:var(--yellow);font-weight:700}
    .status-lag{color:var(--red);font-weight:700}
    @media (max-width:900px){ .progress-box{width:100%} .summary-text{min-width:unset} }
  </style>
</head>
<body>
  <header>
    <div class="small">Auto progress (On Track / Moderate / Lagging) · Comments saved locally · Export Excel / PDF · Expand/Collapse</div>
  </header>

  <!-- Grand Dashboard -->
  <div class="topbar">
    <div class="card"><div class="muted">Total activities</div><h2 id="dbTotal">0</h2></div>
    <div class="card"><div class="muted">On Track</div><h2 id="dbOn">0</h2></div>
    <div class="card"><div class="muted">Moderate</div><h2 id="dbMod">0</h2></div>
    <div class="card"><div class="muted">Lagging</div><h2 id="dbLag">0</h2></div>
    <div class="card"><div class="muted">Overall progress</div><h2 id="dbPct">0%</h2></div>
    <div class="card" style="min-width:200px;max-width:220px">
      <canvas id="globalPie" style="width:100%;height:110px"></canvas>
      <div class="muted">Status breakdown</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <select id="filterTimeline" onchange="render()">
      <option value="">All timelines</option>
      <option value="Monthly">Monthly</option>
      <option value="Quarterly">Quarterly</option>
      <option value="Semi-annual">Semi-annual</option>
      <option value="Annual">Annual</option>
      <option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option><option value="Y1">Y1</option>
    </select>

    <input type="text" id="searchBox" placeholder="Search activity, deliverable, indicator, responsible, comments..." oninput="render()" />
    <div style="margin-left:auto;display:flex;gap:8px">
      <button onclick="toggleAll()">Expand / Collapse All</button>
      <button onclick="exportExcel()">Export to Excel</button>
      <button onclick="exportPDF()">Export to PDF</button>
      <button class="alt" onclick="clearAll()">Clear all progress</button>
    </div>
  </div>

  <div id="tracker" class="tracker"></div>

<script>
/* STORAGE KEY */
const STORAGE_KEY = "MERL_YEAR3_FULL_TRACKER_VFINAL";

/* ===== Full data: all objectives & their activities (web-friendly) =====
   I included all explicit items from your JD and Year3 objectives.
*/
const data = [
  {
    objective: "1. Quality Delivery of MERL Functions",
    activities: [
      { activity: "Design & implement monitoring & evaluation frameworks and tools for COSME", deliverable: "Approved M&E framework & tools", indicator: "Framework implemented", timeline: "Y1", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Ensure execution of functional M&E framework (track outcomes & impacts)", deliverable: "Outcome tracking reports", indicator: "Outcomes tracked monthly", timeline: "Annual", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Maintain activity monitoring logs (easy access & retrieval)", deliverable: "Activity monitoring logs", indicator: "Logs updated within 1 week", timeline: "Monthly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Analyze collected data for progress assessment and improvement areas", deliverable: "Data analysis notes & recommendations", indicator: "Analyses for each reporting period", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Support development of monitoring tools aligned with ToC and M&E Plan", deliverable: "Monitoring tools & SOPs", indicator: "Tools approved & used", timeline: "As Scheduled", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Monitor & evaluate overall progress on achievement and sustainability of results", deliverable: "Progress & sustainability reports", indicator: "Sustainability assessed", timeline: "Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Coordinate periodic reporting with project team (monthly, quarterly, half-yearly, annual)", deliverable: "Consolidated reports", indicator: "Reports submitted on schedule", timeline: "Monthly/Quarterly/Annual", responsible: "MERL Officer + Project Team", status:"", comments:"" },
      { activity: "Manage & conduct quantitative and qualitative monitoring, evaluations and studies", deliverable: "M&E study reports", indicator: "Studies delivered as planned", timeline: "As scheduled", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Design & implement Project Management Information System (MIS) for COSME", deliverable: "Functional MIS", indicator: "MIS operational & updated", timeline: "Weekly/Monthly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Produce MERL reports (monthly, quarterly, annual)", deliverable: "Progress reports", indicator: "100% reports on time & satisfactory", timeline: "Monthly/Quarterly/Annual", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Resolve data quality issues within 2 weeks with documented actions", deliverable: "DQI log & action records", indicator: "100% DQ issues resolved timely", timeline: "Monthly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Maintain MERL risk tracking & mitigation plans", deliverable: "Updated MERL risk log", indicator: "MERL risks tracked quarterly", timeline: "Quarterly", responsible: "MERL Officer + Project Manager", status:"", comments:"" }
    ]
  },

  {
    objective: "2. Managing Project Impact/Results & Partner Accountability",
    activities: [
      { activity: "Coordinate routine monitoring with staff, WROs, YLOs", deliverable: "Monitoring schedules & reports", indicator: "≥90% indicators on track", timeline: "Monthly", responsible: "MERL Officer + Partners", status:"", comments:"" },
      { activity: "Track implementation of indicators & measures of sustainability/success", deliverable: "Indicator tracking tables", indicator: "Indicators monitored quarterly", timeline: "Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Conduct quarterly performance & results review sessions", deliverable: "Review minutes & action points", indicator: "≥1 review session quarterly", timeline: "Quarterly", responsible: "MERL Officer + Project Team", status:"", comments:"" },
      { activity: "Update project information/results on SAP and PMERL", deliverable: "Updated SAP/PMERL entries", indicator: "100% results updated", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Develop & implement partner MERL capacity strengthening plans", deliverable: "Partner MERL plans", indicator: "Plans in place & tracked", timeline: "Q1", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Implement partner MERL capacity strengthening follow-ups", deliverable: "Training follow-up reports", indicator: "100% plans implemented", timeline: "Semi-annual", responsible: "MERL Officer + Partners", status:"", comments:"" },
      { activity: "Track completion of partner follow-up actions", deliverable: "Capacity follow-up log", indicator: "Follow-ups completed on time", timeline: "Q2–Q4", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Facilitate evidence-based adaptations to implementation", deliverable: "Adaptation briefs", indicator: "≥2 adaptations annually", timeline: "Annual", responsible: "MERL Officer + Project Manager", status:"", comments:"" },
      { activity: "Support partners to apply MERL standards & accountability mechanisms", deliverable: "Partner guidance notes & dashboards", indicator: "Partners compliant with MERL SOPs", timeline: "Q1–Q4", responsible: "MERL Officer", status:"", comments:"" }
    ]
  },

  {
    objective: "3. Learning, Knowledge Management & Influencing",
    activities: [
      { activity: "Document case studies, change/impact stories and lessons learned", deliverable: "≥3 case studies / stories", indicator: "≥3 learning products produced", timeline: "Q2 & Q4", responsible: "MERL Officer + Comms", status:"", comments:"" },
      { activity: "Produce evidence products for external networks/forums", deliverable: "Policy briefs / presentations", indicator: "≥2 evidence products shared externally", timeline: "Q3 & Q4", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Disseminate monitoring reports to internal & external audiences", deliverable: "Shared monitoring reports", indicator: "Reports disseminated as scheduled", timeline: "Monthly/Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Develop knowledge products for replication & scaling up", deliverable: "Knowledge briefs & toolkits", indicator: "At least 1 product for scaling", timeline: "Q3", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Create & maintain interactive dashboards and ArcGIS story maps", deliverable: "Live dashboards & story maps", indicator: "Dashboards updated quarterly", timeline: "Q2–Q3", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Document and share best practices and lessons with partners", deliverable: "Learning briefs", indicator: "Lessons fed into project design", timeline: "Q2 & Q4", responsible: "MERL + Partners", status:"", comments:"" },
      { activity: "Maintain an updated database of completed interventions & carry out meta-analysis", deliverable: "Intervention database & meta-analysis", indicator: "Database updated annually", timeline: "Q4", responsible: "MERL Officer", status:"", comments:"" }
    ]
  },

  {
    objective: "4. Capacity Strengthening of Staff, WROs, and YLOs",
    activities: [
      { activity: "Conduct ≥2 MERL capacity-building sessions with staff, WROs, YLOs", deliverable: "Training reports", indicator: "≥80% show improved skills", timeline: "Q2 & Q3", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Train research assistants and partners on MERL tools & methods", deliverable: "Training materials & records", indicator: "100% RAs & partners trained", timeline: "Q1–Q2", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Provide structured coaching, mentorship and follow-up support to partners", deliverable: "Coaching logs & follow-ups", indicator: "100% follow-ups tracked", timeline: "Q1–Q4", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Address identified MERL support needs for partners within agreed timelines", deliverable: "Support tracking log", indicator: "100% needs addressed", timeline: "Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Facilitate reflection & learning sessions with staff and partners", deliverable: "Reflection session notes", indicator: "Learning meeting notes & action points", timeline: "Q2 & Q4", responsible: "MERL + Partners", status:"", comments:"" }
    ]
  },

  {
    objective: "5. Safeguarding & GEI Integration in MERL",
    activities: [
      { activity: "Induct staff, research assistants & partners on Safeguarding and GEI", deliverable: "Induction reports", indicator: "100% inducted", timeline: "Q1", responsible: "MERL Officer + Safeguarding Focal Point", status:"", comments:"" },
      { activity: "Integrate GEI & Safeguarding principles into MERL tools & reports", deliverable: "Revised MERL tools & templates", indicator: "All tools GEI-compliant", timeline: "Q1–Q4", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Conduct quarterly compliance checks on Safeguarding and GEI integration", deliverable: "Compliance reports", indicator: "Quarterly checks completed", timeline: "Quarterly", responsible: "MERL Officer", status:"", comments:"" },
      { activity: "Ensure data is disaggregated by sex, age & disability (SADD)", deliverable: "Disaggregated datasets & tables", indicator: "100% datasets SADD", timeline: "Ongoing", responsible: "MERL Officer", status:"", comments:"" }
    ]
  }
];

/* ===== Load saved statuses/comments from localStorage ===== */
function loadSaved() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const saved = JSON.parse(raw);
    saved.forEach((obj, i) => {
      if (!data[i] || !obj.activities) return;
      obj.activities.forEach((a, j) => {
        if (!data[i].activities[j]) return;
        data[i].activities[j].status = a.status || data[i].activities[j].status || "";
        data[i].activities[j].comments = a.comments || data[i].activities[j].comments || "";
      });
    });
  } catch (e) {
    console.warn("loadSaved error", e);
  }
}

/* ===== Save to localStorage ===== */
function saveAll() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.warn("saveAll error", e);
  }
}

/* ===== Compute counts for activity array ===== */
function computeCounts(activities) {
  let total = activities.length, on = 0, mod = 0, lag = 0;
  activities.forEach(a => {
    if (a.status === "On Track") on++;
    else if (a.status === "Moderate") mod++;
    else lag++; // treat blank or unselected as lagging for progress calculation
  });
  const pct = total === 0 ? 0 : Math.round((on / total) * 100);
  return { total, on, mod, lag, pct };
}

/* ===== Chart ===== */
let pie = null;
function updateGlobalChart(on, mod, lag) {
  const ctx = document.getElementById("globalPie").getContext("2d");
  if (pie) { pie.data.datasets[0].data = [on, mod, lag]; pie.update(); return; }
  pie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['On Track','Moderate','Lagging'],
      datasets: [{ data: [on, mod, lag], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--green').trim() || '#16a34a', getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim() || '#f59e0b', getComputedStyle(document.documentElement).getPropertyValue('--red').trim() || '#ef4444'] }]
    },
    options: { responsive:true, maintainAspectRatio:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* ===== Render UI ===== */
function render() {
  const tracker = document.getElementById("tracker");
  tracker.innerHTML = "";
  const filter = document.getElementById("filterTimeline").value.trim().toLowerCase();
  const search = document.getElementById("searchBox").value.trim().toLowerCase();

  // Global counters
  let g_total=0,g_on=0,g_mod=0,g_lag=0;
  data.forEach(obj => {
    const c = computeCounts(obj.activities);
    g_total += c.total; g_on += c.on; g_mod += c.mod; g_lag += c.lag;
  });
  const g_pct = g_total === 0 ? 0 : Math.round((g_on/g_total)*100);
  document.getElementById("dbTotal").innerText = g_total;
  document.getElementById("dbOn").innerText = g_on;
  document.getElementById("dbMod").innerText = g_mod;
  document.getElementById("dbLag").innerText = g_lag;
  document.getElementById("dbPct").innerText = g_pct + "%";
  updateGlobalChart(g_on,g_mod,g_lag);

  // Build each objective accordion
  data.forEach((obj, objIndex) => {
    const counts = computeCounts(obj.activities);
    // header summary content
    const details = document.createElement("details");
    details.className = "objective";
    details.open = true; // show by default

    const summary = document.createElement("summary");
    summary.className = "obj-summary";
    const title = document.createElement("div"); title.className = "obj-title"; title.innerText = obj.objective;

    const progressBox = document.createElement("div"); progressBox.className = "progress-box";
    const bar = document.createElement("div"); bar.className = "progress-bar";
    const fill = document.createElement("div"); fill.className = "progress-fill";
    fill.style.width = counts.pct + "%";
    // color: green if >=70, yellow if >=40, red otherwise
    if (counts.pct >= 70) fill.style.background = "linear-gradient(90deg,var(--green),#059669)";
    else if (counts.pct >= 40) fill.style.background = "linear-gradient(90deg,var(--yellow),#d97706)";
    else fill.style.background = "linear-gradient(90deg,var(--red),#ef4444)";
    bar.appendChild(fill);
    progressBox.appendChild(bar);

    const summaryText = document.createElement("div"); summaryText.className = "summary-text";
    summaryText.innerText = `Progress: ${counts.pct}% | On Track: ${counts.on} | Moderate: ${counts.mod} | Lagging: ${counts.lag}`;

    summary.appendChild(title);
    summary.appendChild(progressBox);
    summary.appendChild(summaryText);

    // color header by majority
    if (counts.lag >= counts.mod && counts.lag >= counts.on) summary.style.background = "#fecaca";
    else if (counts.mod >= counts.on) summary.style.background = "#fef08a";
    else summary.style.background = "#bbf7d0";

    // panel content (table), but only include rows that pass filter & search
    const panel = document.createElement("div"); panel.className = "panel";

    let table = document.createElement("table");
    let thead = document.createElement("thead");
    thead.innerHTML = `<tr>
      <th>Activity</th><th>Deliverable</th><th>Indicator</th><th>Timeline</th><th>Responsible</th><th>Status</th><th>Comments / Next actions</th>
    </tr>`;
    table.appendChild(thead);
    const tbody = document.createElement("tbody");

    obj.activities.forEach((a, actIndex) => {
      // timeline filter
      if (filter) {
        if (!String(a.timeline).toLowerCase().includes(filter)) return;
      }
      // search filter
      if (search) {
        const hay = (a.activity + " " + a.deliverable + " " + (a.indicator||"") + " " + a.responsible + " " + (a.comments||"")).toLowerCase();
        if (!hay.includes(search)) return;
      }
      const tr = document.createElement("tr");
      const esc = v => String(v||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

      tr.innerHTML = `<td>${esc(a.activity)}</td>
        <td>${esc(a.deliverable)}</td>
        <td>${esc(a.indicator||"")}</td>
        <td>${esc(a.timeline)}</td>
        <td>${esc(a.responsible)}</td>
        <td>
          <select class="status" data-obj="${objIndex}" data-act="${actIndex}" onchange="onStatusChange(this)">
            <option value="" ${a.status===""?"selected":""}>--Select--</option>
            <option value="On Track" ${a.status==="On Track"?"selected":""}>On Track</option>
            <option value="Moderate" ${a.status==="Moderate"?"selected":""}>Moderate</option>
            <option value="Lagging" ${a.status==="Lagging"?"selected":""}>Lagging</option>
          </select>
        </td>
        <td><textarea class="comment" data-obj="${objIndex}" data-act="${actIndex}" onchange="onCommentChange(this)">${esc(a.comments||"")}</textarea></td>`;

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    panel.appendChild(table);

    // Only append if at least one row visible after filters
    if (tbody.children.length > 0) {
      details.appendChild(summary);
      details.appendChild(panel);
      document.getElementById("tracker").appendChild(details);
      // keep panel open if not collapsed; clicking summary toggles open (manual only)
    }

  });

  // ensure global chart & counters up-to-date
  updateGlobalChart(g_on_count(), g_mod_count(), g_lag_count());
}

/* quick global counts (use current data) */
function g_on_count(){ return data.reduce((s,obj)=> s + obj.activities.reduce((a,x)=> a + (x.status==="On Track"?1:0),0),0); }
function g_mod_count(){ return data.reduce((s,obj)=> s + obj.activities.reduce((a,x)=> a + (x.status==="Moderate"?1:0),0),0); }
function g_lag_count(){ return data.reduce((s,obj)=> s + obj.activities.reduce((a,x)=> a + (x.status==="Lagging"?1:0) + (x.status===""?1:0),0),0); }

/* ===== Handlers ===== */
function onStatusChange(selectEl) {
  const objIndex = Number(selectEl.dataset.obj);
  const actIndex = Number(selectEl.dataset.act);
  data[objIndex].activities[actIndex].status = selectEl.value || "";
  saveAll();
  // update UI: re-render to update objective pct & grand dashboard (preserves collapsed/open states)
  render();
}

function onCommentChange(textareaEl) {
  const objIndex = Number(textareaEl.dataset.obj);
  const actIndex = Number(textareaEl.dataset.act);
  data[objIndex].activities[actIndex].comments = textareaEl.value || "";
  saveAll();
  // only update dashboard and chart (no full re-render to keep editor focus)
  updateDashboardOnly();
}

function updateDashboardOnly(){
  const gTotal = data.reduce((s,obj)=> s + obj.activities.length, 0);
  const gOn = g_on_count(), gMod = g_mod_count();
  const gPct = gTotal ? Math.round((gOn / gTotal)*100) : 0;
  document.getElementById("dbTotal").innerText = gTotal;
  document.getElementById("dbOn").innerText = gOn;
  document.getElementById("dbMod").innerText = gMod;
  document.getElementById("dbLag").innerText = g_lag_count();
  document.getElementById("dbPct").innerText = gPct + "%";
  updateGlobalChart(gOn, gMod, g_lag_count());
}

/* ===== Expand/Collapse All ===== */
function toggleAll() {
  const details = document.querySelectorAll("details.objective");
  const anyClosed = [...details].some(d => !d.open);
  details.forEach(d => d.open = anyClosed);
}

/* ===== Export Excel (SheetJS) ===== */
function exportExcel() {
  // build a workbook with one sheet per objective
  const wb = XLSX.utils.book_new();
  data.forEach(obj => {
    const rows = [["Activity", "Deliverable", "Indicator", "Timeline", "Responsible", "Status", "Comments"]];
    obj.activities.forEach(a => {
      rows.push([a.activity, a.deliverable, a.indicator || "", a.timeline, a.responsible, a.status || "", a.comments || ""]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, sanitizeSheetName(obj.objective.substring(0,25)));
  });
  const now = new Date().toISOString().slice(0,19).replace(/:/g,"-");
  XLSX.writeFile(wb, `Individual_Indicators_Performance_Tracker_${now}.xlsx`);
}

/* ===== Export PDF (print-friendly) ===== */
function exportPDF() {
  // Define header details
  const header = `
    <div style="text-align:center;margin-bottom:20px;">
      <h2 style="margin-bottom:10px;color:#0d6efd;">Individual Performance Indicators Tracker</h2>
      <table style="width:100%;border-collapse:collapse;margin:auto;font-size:14px;">
        <tr>
          <td style="padding:4px 8px;width:25%;font-weight:bold;">Name:</td>
          <td style="padding:4px 8px;">Benard Muiruri</td>
          <td style="padding:4px 8px;width:25%;font-weight:bold;">Designation:</td>
          <td style="padding:4px 8px;">MERL Officer</td>
        </tr>
        <tr>
          <td style="padding:4px 8px;font-weight:bold;">Period:</td>
          <td style="padding:4px 8px;">1st July 2025 to 30th June 2026</td>
          <td style="padding:4px 8px;font-weight:bold;">Supervisor:</td>
          <td style="padding:4px 8px;">
            Beryl Oduor<br>
            Senior Project Manager
          </td>
        </tr>
      </table>
      <hr style="margin-top:20px;margin-bottom:25px;border:1px solid #ccc;">
    </div>
  `;

  // Build main printable content
  let html = `
  <html>
  <head>
    <title>Individual Performance Indicators Tracker</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        color: #222;
        margin: 40px;
      }
      h3 {
        color: #0d6efd;
        margin-top: 40px;
        margin-bottom: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: left;
        font-size: 13px;
      }
      th {
        background: #f1f1f1;
      }
      @media print {
        h2, h3 {
          color: black;
        }
      }
    </style>
  </head>
  <body>
  `;

  // Insert header into the printable content
  html += header;

  // Add objectives content
  data.forEach(obj => {
    html += `
      <h3>${obj.objective}</h3>
      <table>
        <thead>
          <tr>
            <th>Activity</th>
            <th>Deliverable</th>
            <th>Indicator</th>
            <th>Timeline</th>
            <th>Responsible</th>
            <th>Status</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody>
    `;

    obj.activities.forEach(a => {
      html += `
        <tr>
          <td>${escapeHtml(a.activity)}</td>
          <td>${escapeHtml(a.deliverable)}</td>
          <td>${escapeHtml(a.indicator || "")}</td>
          <td>${escapeHtml(a.timeline)}</td>
          <td>${escapeHtml(a.responsible)}</td>
          <td>${escapeHtml(a.status || "")}</td>
          <td>${escapeHtml(a.comments || "")}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
  });

  html += `</body></html>`;

  // Open printable window
  const win = window.open("", "_blank", "width=900,height=700");
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 500);
}

/* ===== Utilities ===== */
function sanitizeSheetName(name){
  return name.replace(/[/\\?*[\]]/g, "_");
}
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ===== Clear all progress/comments ===== */
function clearAll() {
  if(!confirm("Reset all statuses and comments? This will clear saved values.")) return;
  data.forEach(obj => obj.activities.forEach(a => { a.status=""; a.comments=""; }));
  saveAll();
  render();
}

/* ===== Init: load and render ===== */
loadSaved();
render();
</script>
</body>
</html>
